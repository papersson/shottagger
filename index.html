<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>xG Shot Tagger</title>
        <script type="text/javascript" src="https://d3js.org/d3.v6.min.js"></script>
        <style type="text/css">
            /* No style rules here yet */		
        </style>
    </head>
    <body bgcolor='#bebdb8'>
    
        <div id="pitch-div" style="text-align: center; position: relative; top: 50%;">
        </div>
        <script type="text/javascript">
            // https://observablehq.com/@cheung927/d3-js-football-pitch/2
            lineColor = "white";
            lineWidth = 3;
            pitchColor = "#acdf87";
            pitchMultiplier = 10;
            pitchWidth = 105;
            pitchHeight = 68;
            margin = {top: 20, right: 20, bottom: 20, left: 20};
            width = pitchWidth * pitchMultiplier;
            height = pitchHeight * pitchMultiplier;
            shotStrokeWidth = 2;

            //const svg = d3.select(DOM.svg(width + margin.left + margin.right, height + margin.top + margin.bottom));
            let svg = d3.select("#pitch-div")
                          .append("svg")
                          .attr("width", width + margin.left + margin.right)
                          .attr("height", height + margin.top + margin.bottom)
                          .style('border', '1px solid #cccccc')
                          .style('box-shadow', '0px 3px 4px 1px rgba(0, 0, 0, 0.75');

            let pitch = svg.append('g')
                            .attr('transform', `translate(${margin.left},${margin.right})`);

            pitch.append('rect')
                .attr('x', -margin.left)
                .attr('y', -margin.top)
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom)
                .style('fill', pitchColor);

            getPitchLines = function () {
                const lines = [];
                // left penalty box
                lines.push({x1: 0, x2: 16.5, y1: pitchHeight/2 - 11 - 9.15, y2: pitchHeight/2 - 11 - 9.15});
                lines.push({x1: 16.5, x2: 16.5, y1: 13.85, y2: pitchHeight/2 + 11 + 9.15});
                lines.push({x1: 0, x2: 16.5, y1: pitchHeight/2 + 11 + 9.15, y2: pitchHeight/2 + 11 + 9.15});
                // left six-yard box
                lines.push({x1: 0, x2: 5.5, y1: pitchHeight/2 - 9.15, y2: pitchHeight/2 - 9.15});
                lines.push({x1: 5.5, x2: 5.5, y1: pitchHeight/2 - 9.15, y2: pitchHeight/2 + 9.15});
                lines.push({x1: 0, x2: 5.5, y1: pitchHeight/2 + 9.15, y2: pitchHeight/2 + 9.15});
                // right penalty box
                lines.push({x1: pitchWidth - 16.5, x2: pitchWidth, y1: pitchHeight/2 - 11 - 9.15, y2: pitchHeight/2 - 11 - 9.15});
                lines.push({x1: pitchWidth - 16.5, x2: pitchWidth - 16.5, y1: pitchHeight/2 - 11 - 9.15, y2: pitchHeight/2 + 11 + 9.15});
                lines.push({x1: pitchWidth - 16.5, x2: pitchWidth, y1: pitchHeight/2 + 11 + 9.15, y2: pitchHeight/2 + 11 + 9.15});
                // right six-yard box
                lines.push({x1: pitchWidth - 5.5, x2: pitchWidth, y1: pitchHeight/2 - 9.15, y2: pitchHeight/2 - 9.15});
                lines.push({x1: pitchWidth - 5.5, x2: pitchWidth - 5.5, y1: pitchHeight/2 - 9.15, y2: pitchHeight/2 + 9.15});
                lines.push({x1: pitchWidth - 5.5, x2: pitchWidth, y1: pitchHeight/2 + 9.15, y2: pitchHeight/2 + 9.15});
                // outside borders
                lines.push({x1: 0, x2: pitchWidth, y1: 0, y2: 0});
                lines.push({x1: 0, x2: pitchWidth, y1: pitchHeight, y2: pitchHeight});
                lines.push({x1: 0, x2: 0, y1: 0, y2: pitchHeight});
                lines.push({x1: pitchWidth, x2: pitchWidth, y1: 0, y2: pitchHeight});
                // middle line
                lines.push({x1: pitchWidth/2, x2: pitchWidth/2, y1: 0, y2: pitchHeight});
                // left goal
                lines.push({x1: -1.5, x2: -1.5, y1: pitchHeight/2 - 7.32/2, y2: pitchHeight/2 + 7.32/2});
                lines.push({x1: -1.5, x2: 0, y1: pitchHeight/2 - 7.32/2, y2: pitchHeight/2 - 7.32/2});
                lines.push({x1: -1.5, x2: 0, y1: pitchHeight/2 + 7.32/2, y2: pitchHeight/2 + 7.32/2});
                // right goal
                lines.push({x1: pitchWidth + 1.5, x2: pitchWidth + 1.5, y1: pitchHeight/2 - 7.32/2, y2: pitchHeight/2 + 7.32/2});
                lines.push({x1: pitchWidth, x2: pitchWidth + 1.5, y1: pitchHeight/2 - 7.32/2, y2: pitchHeight/2 - 7.32/2});
                lines.push({x1: pitchWidth, x2: pitchWidth + 1.5, y1: pitchHeight/2 + 7.32/2, y2: pitchHeight/2 + 7.32/2});
                return lines;
            };

            getPitchCircles2 = function () {
                const circles = [];
                // center circle
                circles.push({cx: pitchWidth/2, cy: pitchHeight/2, r: 9.15, color: 'none'});
                // // left penalty spot
                 circles.push({cx: 11, cy: pitchHeight/2, r: 0.3, color: lineColor});
                // // right penalty spot
                 circles.push({cx: pitchWidth - 11, cy: pitchHeight/2, r: 0.3, color: lineColor});
                // // kick-off circle
                circles.push({cx: pitchWidth/2, cy: pitchHeight/2, r: 0.3, color: lineColor});
                return circles;
            };

            getArcs = function () {
                const arcs = [];
                const cornerRadius = 1 * pitchMultiplier;
                const penaltyRadius = 9.15 * pitchMultiplier;
                // left top corner
                arcs.push({arc: {innerRadius: cornerRadius, outerRadius: cornerRadius + lineWidth, startAngle: 1/2 * Math.PI, endAngle: Math.PI}, 'x': 0, 'y': 0});
                // left bottom corner
                arcs.push({arc: {innerRadius: cornerRadius, outerRadius: cornerRadius + lineWidth, startAngle: 1/2 * Math.PI, endAngle: 0}, 'x': 0, 'y': pitchHeight});
                // right top corner
                arcs.push({arc: {innerRadius: cornerRadius, outerRadius: cornerRadius + lineWidth, startAngle: 3/2 * Math.PI, endAngle: Math.PI}, 'x': pitchWidth, 'y': 0});
                // right bottom corner
                arcs.push({arc: {innerRadius: cornerRadius, outerRadius: cornerRadius + lineWidth, startAngle: 2 * Math.PI, endAngle: 3/2 * Math.PI}, 'x': pitchWidth, 'y': pitchHeight});
                // left penalty arc
                arcs.push({arc: {innerRadius: penaltyRadius, outerRadius: penaltyRadius + lineWidth, startAngle: Math.sin(6.5/9.15), endAngle: Math.PI - Math.sin(6.5/9.15)}, 'x': 11, 'y': pitchHeight/2});
                // right penalty arc
                arcs.push({arc: {innerRadius: penaltyRadius, outerRadius: penaltyRadius + lineWidth, startAngle: -Math.sin(6.5/9.15), endAngle: -(Math.PI - Math.sin(6.5/9.15))}, 'x': pitchWidth - 11, 'y': pitchHeight/2});
                return arcs;
            };
                
            const pitchLineData = getPitchLines();
            pitch.selectAll('.pitchLines')
                .data(pitchLineData)
                .enter()
                .append('line')
                .attr('x1', d => d['x1'] * pitchMultiplier)
                .attr('x2', d => d['x2'] * pitchMultiplier)
                .attr('y1', d => d['y1'] * pitchMultiplier)
                .attr('y2', d => d['y2'] * pitchMultiplier)
                .style('stroke-width', lineWidth)
                .style('stroke', lineColor);

            const pitchCircleData = getPitchCircles2();
            pitch.selectAll('.pitchCircles')
                .data(pitchCircleData)
                .enter()
                .append('circle')
                .attr('cx', d => d['cx'] * pitchMultiplier)
                .attr('cy', d => d['cy'] * pitchMultiplier)
                .attr('r', d => d['r'] * pitchMultiplier)
                .style('stroke-width', lineWidth)
                .style('stroke', lineColor)
                .style('fill', d => d['color']);

            const pitchArcData = getArcs();
            const arc = d3.arc();
            pitch.selectAll('.pitchCorners')
                .data(pitchArcData)
                .enter().append('path')
                .attr('d', d => arc(d['arc']))
                .attr('transform', d => `translate(${pitchMultiplier * d.x},${pitchMultiplier * d.y})`)
                .style('fill', lineColor);    
            pitch.append('text')
                 .text('Goals: 0 (0)')
                 .attr('class', 'score-text')
                 .attr('x', pitchMultiplier * 105/2)
                 .attr('y', pitchMultiplier * 4)
                 .attr('font-family', 'roboto-mono')
                 .attr('font-size', '50px')
                 .attr('fill', 'black')
                 .attr('text-anchor', 'middle')
                 .attr('dominant-baseline', 'central');
            pitch.append('text')
                 .text('Left click for missed shot')
                 .attr('class', 'focus-text-1')
                 .attr('x', pitchMultiplier * 70)
                 .attr('y', pitchMultiplier * 4)
                 .attr('font-family', 'roboto-mono')
                 .attr('font-size', '25px')
                 .attr('fill', 'black');
            pitch.append('text')
                 .text('Right click for goal')
                 .attr('class', 'focus-text-2')
                 .attr('x', pitchMultiplier * 70)
                 .attr('y', pitchMultiplier * 7)
                 .attr('font-family', 'roboto-mono')
                 .attr('font-size', '25px')
                 .attr('fill', 'black');

            let rScale = d3.scaleSqrt()
                           .domain([0, 1])
                           .range([2, 20]);
            let isVisible = true;
            let scoreTotal = 0;
            let xgTotal = 0;
            pitch.on('click contextmenu', (event) => {
                event.preventDefault();
                outcome = event.button == 0 ? 0 : 1;
                //if (isVisible) {
                //    isVisible = false;
                //    d3.selectAll('.focus-text')
                //      .style('visibility', 'hidden');
                //}
                shotLocation = d3.pointer(event).map(x => x / pitchMultiplier);
                const goalCoords = [105, 34];
                
                let fovArea = pitch.append('path')
                    .attr('class', 'fov-area')
                    .attr('d', () => {
                        const p0 = {'x': shotLocation[0] * pitchMultiplier, 'y': shotLocation[1] * pitchMultiplier}
                        const p1 = {'x': goalCoords[0] * pitchMultiplier, 'y': (goalCoords[1] + 7.32/2) * pitchMultiplier}
                        const p2 = {'x': goalCoords[0] * pitchMultiplier, 'y': (goalCoords[1] - 7.32/2) * pitchMultiplier}
                        return `M ${p0.x} ${p0.y} L ${p1.x} ${p1.y} L ${p2.x} ${p2.y} z`

                    })
                     .style('fill', 'grey')
                     .style('opacity', 0.5);

                d3.selectAll('.focus-text-1')
                  .text('Tag defenders inside the grey area');
                d3.selectAll('.focus-text-2')
                  .text('Press enter when done');
                defenders = [];
                fovArea.on('click', event => {
                    event.stopPropagation();
                    defLocation = d3.pointer(event).map(x => x / pitchMultiplier);
                    defenders.push(defLocation);
                    pitch.append('circle')
                       .attr('class', 'defender')
                       .attr('cx', defLocation[0] * pitchMultiplier)
                       .attr('cy', defLocation[1] * pitchMultiplier)
                       .attr('r', 5)
                       .style('stroke-width', shotStrokeWidth)
                       .style('stroke', 'black')
                       .style('fill', 'red');
                });

                d3.select('body')
                  .on('keypress', event =>  {
                      if (event.key == 'Enter') {
                          let requestBody = {'shotLocation': shotLocation, 'defenders': defenders};
                          fetch('/predict', {
                              method: 'POST',
                              headers: {'Content-Type': 'application/json'},
                              body: JSON.stringify(requestBody)
                          })
                          .then(response => response.json())
                          .then(data => {
                              xg = data.xg;
                              pitch.append("circle")
                                 .attr('class', 'shot-circle')
                                 .attr("cx", shotLocation[0] * pitchMultiplier)
                                 .attr("cy", shotLocation[1] * pitchMultiplier)
                                 .attr("r", rScale(xg))
                                 .style('stroke-width', shotStrokeWidth)
                                 .style('stroke', '#000000')
                                 // Grey if left click, yellow else
                                 .style('fill', outcome == 0 ? '#999993' : "yellow");

                              pitch.append('text')
                                  .text(`${xg.toFixed(2)}`)
                                  .attr('x', shotLocation[0] * pitchMultiplier)
                                  .attr('y', shotLocation[1] * pitchMultiplier + 25)
                                  .attr('font-family', 'roboto-mono')
                                  .attr('font-size', '15px')
                                  .attr('fill', 'black')
                                  .attr('text-anchor', 'middle')
                                  .attr('dominant-baseline', 'central');

                              scoreTotal += outcome;
                              xgTotal += xg;
                              d3.select('.score-text')
                                .text(`Goals: ${scoreTotal} (${xgTotal.toFixed(2)})`);
                          });
                      }
                      d3.selectAll('.focus-text-1')
                        .text('Right click for goal');
                      d3.selectAll('.focus-text-2')
                        .text('Left click for missed shot');
                      d3.selectAll('.fov-area').remove();
                      d3.selectAll('.defender').remove();
                      
                  });

            });

        </script>
    </body>
</html>
